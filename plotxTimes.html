<head>
  <!-- Plotly.js -->
  <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="plotly-latest.min.js"></script>
  <script src="shelling-3.js"></script>
  <script src="node_modules/seedrandom/seedrandom.min.js"></script>
</head>

<body>
  <div style="text-align: right">
    <div>
      <label for="seedText">Seed:</label><input type="text" id="seedText" />
    </div>
    <div>
      <label for="xtimesText">Number of Times:</label
      ><input type="text" id="xtimesText" />
    </div>
    <div>
      <label for="occupancyText">Occupancy:</label
      ><input type="text" id="occupancyText" />
    </div>

    <div>
      <label for="segmentThresholdText">Threshold:</label
      ><input type="text" id="segmentThresholdText" />
    </div>
    <div>
      <span>
        <label for="propAText">Proportion A:</label
        ><input type="text" id="propAText" />
        <label for="propBText">Proportion B:</label
        ><input type="text" id="propBText" />
      </span>
    </div>
    <div>
      <span>
        <label for="cityAText">City A Size:</label
        ><input type="text" id="cityAText" />
        <label for="cityBText">City B Size:</label
        ><input type="text" id="cityBText" />
      </span>
    </div>
    <button type="button" id="runPlot" onclick="runPlot()">Click Me!</button>
  </div>

  <div>
    <div id="myDivX1"><!-- Plotly chart will be drawn inside this DIV --></div>
    <div>
      <label for="iterationsDiv">Iterations:</label>
      <span id="iterationsDiv"></span>
    </div>
    <div>
      <label for="segmentationDiv">Segmentation:</label>
      <span id="segmentationDiv"></span>
    </div>
    <div>
      <label for="failedToStop">Failed to Stop:</label>
      <span id="failedToStop"></span>
    </div>
    <div>
      <label for="paramsDiv">params = </label>
      <span id="paramsDiv"></span>
    </div>
    <div id="myDiv3"><!-- Plotly chart will be drawn inside this DIV --></div>
  </div>

  <script>
    var params = {
      runXtimes: 50,
      cityHeight: 30,
      cityWidth: 30,
      occupancy: 0.9,
      populationProportions: [0, 0.6, 0.4],
      segmentRatio: 0.5,
      seed: "hello"

      // Seed with one 2000
      // seed: 0.8024624793347311
      // seed: "0.8051979114263961"
    };

    var params2 = { ...params, cityHeight: 7, cityHeight: 7 };

    // Make randomness repeatable
    var seedString;
    if (params.seed === "") seedString = "hello";
    else seedString = params.seed;

    $("#seedText").val(seedString);
    $("#xtimesText").val(params.runXtimes);
    $("#occupancyText").val(params.occupancy);
    $("#segmentThresholdText").val(params.segmentRatio);
    $("#propAText").val(params.populationProportions[1]);
    $("#propBText").val(params.populationProportions[2]);
    $("#cityAText").val(params.cityHeight);
    $("#cityBText").val(params2.cityHeight);

    function graphPlot(divName, mat) {
      //var [howLong, segmentedCount] = runShelling(cityMat, params);

      // var histogram = runXtimes(params);

      var colorscaleValue = [[0, "#ffffff"], [0.5, "#001f3f"], [1, "#edf547"]];
      var data = [
        {
          z: mat,
          type: "heatmap",
          colorscale: colorscaleValue,
          showscale: false,
          showticklabels: false
        }
      ];

      var axisTemplate = {
        // range: [0, 1.6],
        // autorange: false,
        showgrid: false,
        zeroline: false,
        linecolor: "black",
        showticklabels: false,
        ticks: ""
      };

      var layout = {
        //title: "Heatmap with Unequal Block Sizes",
        margin: {
          t: 20,
          r: 20,
          b: 20,
          l: 20
        },
        showlegend: false,
        xaxis: axisTemplate,
        yaxis: axisTemplate,
        width: 300,
        height: 300,
        autosize: false
      };

      Plotly.newPlot(divName, data, layout, { showSendToCloud: false });
    }

    function linePlot(divName, x_array, y_array) {
      var trace1 = {
        x: x_array,
        y: y_array,
        mode: "lines+markers",
        type: "scatter"
      };

      var data = [trace1];

      var layout = {
        //title: "Heatmap with Unequal Block Sizes",
        margin: {
          t: 20,
          r: 20,
          b: 20,
          l: 20
        },
        // showlegend: false,
        // xaxis: axisTemplate,
        // yaxis: axisTemplate,
        width: 300,
        height: 300,
        autosize: false
      };

      Plotly.newPlot(divName, data, layout);
    }

    function updateVars() {
      if ($("#seedText").val() !== "") {
        params.seed = seedString = $("#seedText").val();
      }

      if ($("#xtimesText").val() !== "") {
        params.runXtimes = $("#xtimesText").val();
      }

      if ($("#occupancyText").val() !== "") {
        params.occupancy = $("#occupancyText").val();
      }

      if ($("#segmentThresholdText").val() !== "") {
        params.segmentRatio = $("#segmentThresholdText").val();
      }
      if ($("#propAText").val() !== "") {
        params.populationProportions[1] = $("#propAText").val();
      }
      if ($("#propBText").val() !== "") {
        params.populationProportions[2] = $("#propBText").val();
      }

      if ($("#cityAText").val() !== "") {
        params.cityHeight = params.cityWidth = parseInt(
          $("#cityAText").val(),
          10
        );
      }

      if ($("#cityBText").val() !== "") {
        params2.cityHeight = params2.cityWidth = parseInt(
          $("#cityBText").val(),
          10
        );
      }

      $("#seedDiv").text(seedString);
      Math.seedrandom(seedString);
      $("#seedText").val(Math.random());
    }

    function runSession(params, params2) {
      var cityMat = Array(params.cityHeight)
        .fill()
        .map(() => Array(params.cityWidth).fill(0));

      var suburbMat = Array(params2.cityHeight)
        .fill()
        .map(() => Array(params2.cityWidth).fill(0));

      populate(cityMat, params);
      // populate city but suburbs are empty

      var [iterations, segmentation] = runShelling2(
        cityMat,
        params,
        suburbMat,
        params2
      );

      return [iterations, segmentation];
    }

    // Called by Button
    function runPlot() {
      updateVars();
      var histogram = [];

      segmentationAvg = 0;

      for (var i = 0; i < params.runXtimes; i++) {
        [iterations, segmentation] = runSession(params, params2);

        var index = iterations.toString();
        if (histogram[index] == null) histogram[index] = 1;
        else histogram[index] = histogram[index] + 1;
        segmentationAvg +=
          segmentation.pop() /
          (params.cityHeight *
            params.cityWidth *
            params.occupancy *
            params.runXtimes);
      }

      $("#iterationsDiv").text(iterations);
      $("#segmentationDiv").text(segmentationAvg);

      // TODO: build a histogram with the average number of iteration per population size relative to city size/ crowd size for minor or majority
      $("#paramsDiv").text(JSON.stringify(params));
      // graphPlot("myDiv2", cityMat);
      // graphPlot("myDiv22", suburbMat);

      $("#failedToStop").text(
        //params.cityHeight * params.cityWidth * params.occupancy
        // Object.keys(histogram)
        // Object.keys(histogram).length

        // histogram.filter(number => number !== null)
        function() {
          if (histogram[2000] !== null) {
            return histogram[2000];
          } else {
            return "none";
          }
        }
      );

      delete histogram[2000];

      filteredHisto = histogram.filter(number => number !== null);
      linePlot("myDiv3", [...Object.keys(histogram)], [...filteredHisto]);
    }

    runPlot();
  </script>
</body>
